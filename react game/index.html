<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <title>React Image Matcher</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<div id="content"></div>
<script type="text/jsx">

    var App = {
        defaultImageArray: [
            'cat1.jpg',
            'cat2.jpg'
        ],
        cards: [],
        openCards: []
    };

    var Container = React.createClass({
        getInitialState: function () {
            return {cards: this.props.cards};
        },
        onImageClick: function (i) {
            var tempCards = this.state.cards,
                    currentCard = tempCards[ i ];

            if ( currentCard.isResolved ) {
                return;
            }
            currentCard.isVisible = true;

            App.openCards.push(currentCard);

            if ( App.openCards.length === 2 ) {
                var firstCard = App.openCards[ 0 ],
                        secondCard = App.openCards[ 1 ];

                if ( firstCard.image != secondCard.image ) {
                    tempCards.forEach(function (card) {
                        card.isVisible = false;
                    });
                } else {
                    _.filter(tempCards, function (card) {
                        return card.id === firstCard.id || card.id === secondCard.id;
                    }).forEach(function (card) {
                        card.isResolved = true;
                    });
                }
                App.openCards = [];
            }

            this.setState({cards: tempCards});
        },
        restartGame: function () {
            this.setState({cards: mixCards(App.defaultImageArray)});
        },
        render: function () {
            var imageCards = this.state.cards.map(function (card) {
                return (
                        <Image card={card} localHandleClick={this.onImageClick}></Image>
                );
            }, this);

            return (
                    <div className="container">
                        {imageCards}
                        <Button localButtonClick={this.restartGame}/>
                        <label>{this.props.renderTime.toString()}</label>
                    </div>
            );
        }
    });

    var Image = React.createClass({
        render: function () {
            return (
                    <img src={this.props.card.isVisible? this.props.card.image:''}
                         onClick={this.props.localHandleClick.bind(null,this.props.card.id)}
                         className="imageCard">
                    </img>
            );
        }
    });

    var Button = React.createClass({
        render: function () {
            return (
                    <button onClick={this.props.localButtonClick}>Restart game</button>
            );
        }
    });

    startApp();

    function startApp(time) {
        App.cards = mixCards(App.defaultImageArray);

        React.render(
                <Container cards={App.cards} renderTime={new Date()}/>,
                document.getElementById('content')
        );
    }

    function mixCards(imageArray) {
        var cardCount = imageArray.length * 2,
                mixedArray = _.shuffle(_.range(cardCount)),
                cards = [];

        imageArray.concat(imageArray).forEach(function (card, ind) {
            cards.push({id: mixedArray[ ind ], image: card, isVisible: false});
        });

        return _.sortBy(cards, 'id');
    }
</script>
</body>

</html>
